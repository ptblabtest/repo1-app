model Budget {
  id           String    @id @default(uuid())
  regNumber    String?
  description  String?
  amount       Decimal?
  approvedDate DateTime?
  revision     Decimal?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  assignee    User?   @relation("Assignee", fields: [assigneeId], references: [id])
  assigneeId  String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?

  items BudgetItem[]

  project   Project? @relation(fields: [projectId], references: [id])
  projectId String?

  notes  Note[]
  stages Stage[]
}

model BudgetItem {
  id       String @id @default(uuid())
  budgetId String

  categoryId  String?
  description String
  quantity    Decimal
  timeUnit    Decimal?
  unitPrice   Decimal
  amount      Decimal

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  budget   Budget    @relation(fields: [budgetId], references: [id])
  category CostType? @relation(fields: [categoryId], references: [id])
}

model Fund {
  id                 String    @id @default(uuid())
  regNumber          String?
  description        String
  amount             Decimal?
  requestDate        DateTime?
  approvedDate       DateTime?
  closedDate         DateTime?
  expiredDate        DateTime?
  voidDate           DateTime?
  plannedPaymentDate DateTime?
  type               String?
  revision           Decimal?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  assignee    User?   @relation("Assignee", fields: [assigneeId], references: [id])
  assigneeId  String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?

  items FundItem[]

  task   Task?   @relation(fields: [taskId], references: [id])
  taskId String?

  expenses Expense[]

  notes  Note[]
  stages Stage[]
}

model FundItem {
  id     String @id @default(uuid())
  fundId String

  categoryId  String?
  description String
  quantity    Decimal
  timeUnit    Decimal?
  unitPrice   Decimal
  amount      Decimal

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  fund     Fund      @relation(fields: [fundId], references: [id])
  category CostType? @relation(fields: [categoryId], references: [id])
}

model Expense {
  id          String    @id @default(uuid())
  regNumber   String?
  categoryId  String
  description String?
  amount      Decimal
  date        DateTime?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  category CostType @relation(fields: [categoryId], references: [id])

  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?

  fund   Fund?   @relation(fields: [fundId], references: [id])
  fundId String?

  task   Task?   @relation(fields: [taskId], references: [id])
  taskId String?

  project   Project? @relation(fields: [projectId], references: [id])
  projectId String?

  notes Note[]
}

model CostType {
  id       String  @id @default(uuid())
  order    Int?
  name     String
  parentId String?

  parent   CostType?  @relation("CostTypeHierarchy", fields: [parentId], references: [id])
  children CostType[] @relation("CostTypeHierarchy")

  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?

  budgetItems BudgetItem[]
  fundItems   FundItem[]
  expenses    Expense[]
}

model Pipeline {
  id        String  @id @default(uuid())
  regNumber String?
  category  String?

  // Non-unique relations (multiple pipelines can reference same record)
  leadId String?
  lead   Lead?   @relation(fields: [leadId], references: [id])

  opportunityId String?
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id])

  quoteId String?
  quote   Quote?  @relation(fields: [quoteId], references: [id])

  contractId String?
  contract   Contract? @relation(fields: [contractId], references: [id])

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  assignee    User?   @relation("Assignee", fields: [assigneeId], references: [id])
  assigneeId  String?
  members     User[]  @relation("PipelineMembers")
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?

  // Pipeline owns these
  stages Stage[]
  notes  Note[]
  events Event[]
}

model Lead {
  id                String    @id @default(uuid())
  regNumber         String?
  name              String?
  role              String?
  email             String?
  phone             String?
  leadSource        String?
  leadDate          DateTime?
  leadAddress       String?
  description       String?
  prospectLocation  String?
  approvedDate      DateTime?
  expectedCloseDate DateTime?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  products      Product[]
  client        Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)
  clientId      String?
  opportunities Opportunity[]

  pipeline Pipeline[]
}

model Opportunity {
  id                String    @id @default(uuid())
  regNumber         String?
  title             String
  currency          String?
  baseAmount        Decimal?
  exchangeRate      Decimal?
  amount            Decimal?
  expectedCloseDate DateTime?
  description       String?
  approvedDate      DateTime?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  products Product[]
  client   Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  clientId String?
  lead     Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)
  leadId   String?

  quotes Quote[]

  pipeline Pipeline[]
}

model Quote {
  id                String    @id @default(uuid())
  regNumber         String?
  title             String
  currency          String?
  baseAmount        Decimal?
  exchangeRate      Decimal?
  amount            Decimal?
  releasedDate      DateTime?
  approvedDate      DateTime?
  expiredDate       DateTime?
  expectedCloseDate DateTime?
  description       String?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  products      Product[]
  client        Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)
  clientId      String?
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  opportunityId String?

  contracts Contract[]
  pipeline  Pipeline[]
}

model Contract {
  id            String    @id @default(uuid())
  regNumber     String?
  title         String
  signedDate    DateTime?
  startDate     DateTime?
  endDate       DateTime?
  description   String?
  penalty       Boolean?  @default(false)
  currency      String?
  baseAmount    Decimal?
  exchangeRate  Decimal?
  amount        Decimal?
  clientPicName String?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  products Product[]
  client   Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  clientId String?
  quote    Quote?    @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  quoteId  String?

  project  Project?
  pipeline Pipeline[]
}

model Event {
  id          String    @id @default(uuid())
  title       String
  category    String?
  description String?
  startDate   DateTime?
  endDate     DateTime?
  url         String?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?

  pipeline    Pipeline?  @relation(fields: [pipelineId], references: [id])
  pipelineId  String?
  project     Project?   @relation(fields: [projectId], references: [id])
  projectId   String?
  milestone   Milestone? @relation(fields: [milestoneId], references: [id])
  milestoneId String?
  task        Task?      @relation(fields: [taskId], references: [id])
  taskId      String?
}

model Note {
  id          String  @id @default(uuid())
  description String?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?

  pipeline    Pipeline?  @relation(fields: [pipelineId], references: [id])
  pipelineId  String?
  project     Project?   @relation(fields: [projectId], references: [id])
  projectId   String?
  milestone   Milestone? @relation(fields: [milestoneId], references: [id])
  milestoneId String?
  task        Task?      @relation(fields: [taskId], references: [id])
  taskId      String?

  budget    Budget?  @relation(fields: [budgetId], references: [id])
  budgetId  String?
  fund      Fund?    @relation(fields: [fundId], references: [id])
  fundId    String?
  expense   Expense? @relation(fields: [expenseId], references: [id])
  expenseId String?
  client    Client?  @relation(fields: [clientId], references: [id])
  clientId  String?
  vendor    Vendor?  @relation(fields: [vendorId], references: [id])
  vendorId  String?
}

model Stage {
  id          String  @id @default(uuid())
  stageTypeId String
  comment     String?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  type StageType @relation(fields: [stageTypeId], references: [id])

  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?

  pipeline    Pipeline?  @relation(fields: [pipelineId], references: [id])
  pipelineId  String?
  project     Project?   @relation(fields: [projectId], references: [id])
  projectId   String?
  milestone   Milestone? @relation(fields: [milestoneId], references: [id])
  milestoneId String?
  task        Task?      @relation(fields: [taskId], references: [id])
  taskId      String?

  budget   Budget? @relation(fields: [budgetId], references: [id])
  budgetId String?
  fund     Fund?   @relation(fields: [fundId], references: [id])
  fundId   String?
}

model StageType {
  id    String  @id @default(uuid())
  model String
  order Decimal
  value String

  stages Stage[]
}

model Client {
  id                     String  @id @default(uuid())
  regNumber              String?
  name                   String
  address                String?
  phone                  String?
  email                  String?
  legal                  String?
  category               String?
  country                String?
  contactName            String?
  contactRole            String?
  contactPhone           String?
  contactEmail           String?
  taxNumber              String?
  taxAddress             String?
  taxStatus              Boolean @default(false)
  procurementName        String?
  procurementRole        String?
  procurementPhone       String?
  procurementEmail       String?
  billingAddress         String?
  paymentName            String?
  paymentRole            String?
  paymentPhone           String?
  paymentEmail           String?
  bankName               String?
  accountReferenceNumber String?
  accountOwnerName       String?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?

  notes Note[]

  leads         Lead[]
  opportunities Opportunity[]
  quotes        Quote[]
  contracts     Contract[]
}

model Vendor {
  id                     String  @id @default(uuid())
  regNumber              String?
  name                   String
  address                String?
  phone                  String?
  email                  String?
  city                   String?
  postalCode             String?
  legal                  String?
  vendorCategory         String?
  contactName            String?
  contactRole            String?
  contactPhone           String?
  contactEmail           String?
  taxNumber              String?
  taxStatus              Boolean @default(false)
  siupNumber             String?
  nibNumber              String?
  pkpNumber              String?
  productType            String?
  description            String?
  bankName               String?
  accountReferenceNumber String?
  accountOwnerName       String?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?

  notes Note[]
}

model Product {
  id          String  @id @default(uuid())
  regNumber   String?
  name        String
  description String?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?

  leads         Lead[]
  opportunities Opportunity[]
  quotes        Quote[]
  contracts     Contract[]
}

model Category {
  id    String @id @default(uuid())
  key   String
  value String
  label String
}

model Country {
  id   String  @id @default(uuid())
  name String?
  code String?
}

model Project {
  id               String    @id @default(uuid())
  regNumber        String?
  progress         Decimal?  @default(0)
  plannedStartDate DateTime?
  plannedEndDate   DateTime?
  actualStartDate  DateTime?
  actualEndDate    DateTime?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  contract   Contract? @relation(fields: [contractId], references: [id])
  contractId String?   @unique

  assignee    User?   @relation("Assignee", fields: [assigneeId], references: [id])
  assigneeId  String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?
  members     User[]  @relation("ProjectMembers")

  milestones Milestone[]

  notes    Note[]
  stages   Stage[]
  events   Event[]
  budgets  Budget[]
  expenses Expense[]
}

model Milestone {
  id               String    @id @default(uuid())
  order            Decimal?
  title            String?
  description      String?
  plannedStartDate DateTime?
  plannedEndDate   DateTime?
  actualStartDate  DateTime?
  actualEndDate    DateTime?
  approvedDate     DateTime?
  share            Decimal?
  amount           Decimal?
  deliverables     String?
  progress         Decimal?  @default(0)
  revision         Decimal?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  project   Project? @relation(fields: [projectId], references: [id])
  projectId String?

  assignee    User?   @relation("Assignee", fields: [assigneeId], references: [id])
  assigneeId  String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?

  tasks Task[]

  notes  Note[]
  stages Stage[]
  events Event[]
}

model Task {
  id               String    @id @default(uuid())
  order            Decimal?
  title            String
  plannedStartDate DateTime?
  plannedEndDate   DateTime?
  actualStartDate  DateTime?
  actualEndDate    DateTime?
  progress         Decimal?  @default(0)
  deliverables     String?
  remarks          String?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  milestone   Milestone @relation(fields: [milestoneId], references: [id])
  milestoneId String

  assignee    User?   @relation("Assignee", fields: [assigneeId], references: [id])
  assigneeId  String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?
  members     User[]  @relation("TaskMembers")

  notes    Note[]
  stages   Stage[]
  events   Event[]
  expenses Expense[]
  funds    Fund[]
}

model User {
  id       String @id @default(uuid())
  username String @unique
  password String

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  status String @default("ACTIVE")

  role           Role?         @relation(fields: [roleId], references: [id])
  roleId         String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?

  profile Profile?

  BudgetAssignee Budget[] @relation("Assignee")
  CreatorBudget  Budget[] @relation("CreatedBy")
  UpdaterBudget  Budget[] @relation("UpdatedBy")

  CreatorClient Client[] @relation("CreatedBy")
  UpdaterClient Client[] @relation("UpdatedBy")

  CreatorEvent Event[] @relation("CreatedBy")
  UpdaterEvent Event[] @relation("UpdatedBy")

  CreatorExpense Expense[] @relation("CreatedBy")
  UpdaterExpense Expense[] @relation("UpdatedBy")

  FundAssignee Fund[] @relation("Assignee")
  CreatorFund  Fund[] @relation("CreatedBy")
  UpdaterFund  Fund[] @relation("UpdatedBy")

  MilestoneAssignee Milestone[] @relation("Assignee")
  CreatorMilestone  Milestone[] @relation("CreatedBy")
  UpdaterMilestone  Milestone[] @relation("UpdatedBy")

  CreatorNote Note[] @relation("CreatedBy")
  UpdaterNote Note[] @relation("UpdatedBy")

  CreatorProduct Product[] @relation("CreatedBy")
  UpdaterProduct Product[] @relation("UpdatedBy")

  ProjectAssignee Project[] @relation("Assignee")
  CreatorProject  Project[] @relation("CreatedBy")
  UpdaterProject  Project[] @relation("UpdatedBy")
  ProjectMember   Project[] @relation("ProjectMembers")

  CreatorStage Stage[] @relation("CreatedBy")
  UpdaterStage Stage[] @relation("UpdatedBy")

  TaskAssignee Task[] @relation("Assignee")
  CreatorTask  Task[] @relation("CreatedBy")
  UpdaterTask  Task[] @relation("UpdatedBy")
  TaskMember   Task[] @relation("TaskMembers")

  PipelineAssignee Pipeline[] @relation("Assignee")
  CreatorPipeline  Pipeline[] @relation("CreatedBy")
  UpdaterPipeline  Pipeline[] @relation("UpdatedBy")
  PipelineMember   Pipeline[] @relation("PipelineMembers")

  CreatorVendor Vendor[] @relation("CreatedBy")
  UpdaterVendor Vendor[] @relation("UpdatedBy")

  CreatorProfile Profile[] @relation("CreatedBy")
  UpdaterProfile Profile[] @relation("UpdatedBy")

  CreatorCostType CostType[] @relation("CreatedBy")
  UpdaterCostType CostType[] @relation("UpdatedBy")
}

model Role {
  id    String @id @default(uuid())
  name  String @unique
  level Int

  users User[]
}

model Organization {
  id   String  @id @default(uuid())
  name String  @unique
  code String? @unique

  users User[]
}

model Profile {
  id       String    @id @default(uuid())
  name     String?
  joinDate DateTime?

  createdAt DateTime? @default(now())
  updatedAt DateTime? @updatedAt

  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById String?

  user   User   @relation(fields: [userId], references: [id])
  userId String @unique
}

model Session {
  sid    String   @id(map: "session_pkey") @db.VarChar
  sess   Json     @db.Json
  expire DateTime @db.Timestamp(6)

  @@index([expire], map: "IDX_session_expire")
}

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"

  // generatedFileExtension = "ts"
  // importFileExtension    = "ts"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
